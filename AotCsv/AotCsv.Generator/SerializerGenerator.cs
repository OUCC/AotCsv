using System.Text;
using Microsoft.CodeAnalysis;
using Oucc.AotCsv.Generator.Utility;

namespace Oucc.AotCsv.Generator;

[Generator(LanguageNames.CSharp)]
public partial class SerializerGenerator : IIncrementalGenerator
{
    public void Initialize(IncrementalGeneratorInitializationContext context)
    {
        var source = context.SyntaxProvider.ForAttributeWithMetadataName(
            "Oucc.AotCsv.Attributes.CsvSerializableAttribute",
            static (_, _) => true,
            static (context, _) => context);

        context.RegisterSourceOutput(source, Emit);
    }

    private void Emit(SourceProductionContext context, GeneratorAttributeSyntaxContext source)
    {
        var targetSymbol = (INamedTypeSymbol)source.TargetSymbol;

        var builder = new StringBuilder();

        builder.Append("""
            // <auto-generated/>

            """);

        if (!targetSymbol.ContainingNamespace.IsGlobalNamespace)
            builder.AppendFormatted($"namespace {targetSymbol.ContainingNamespace.ToString()};\n");

        builder.AppendFormatted($$"""

            partial {{(targetSymbol.TypeKind == TypeKind.Class ? "class" : "struct")}} {{targetSymbol.Name}} : global::Oucc.AotCsv.ICsvSerializable<{{targetSymbol.Name}}>
            {
                static void global::Oucc.AotCsv.ICsvSerializable<{{targetSymbol.Name}}>.WriteHeader(global::System.IO.TextWriter writer, global::Oucc.AotCsv.CsvSerializeConfig context)
                {
            """);

        CreateHeaderCode(builder, targetSymbol);

        builder.AppendFormatted($$"""
                }

                static void global::Oucc.AotCsv.ICsvSerializable<{{targetSymbol.Name}}>.WriteRecord(global::System.IO.TextWriter writer, global::Oucc.AotCsv.CsvSerializeConfig config, {{targetSymbol.Name}} value)
                {
            """);

        CreateBodyCode(builder, targetSymbol);

        builder.Append("""
                }
            }

            """);

        context.AddSource(targetSymbol.Name + ".g.cs", builder.ToString());
    }
}
